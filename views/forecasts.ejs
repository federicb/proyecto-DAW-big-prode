<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="/styles/universal.css">
    <link rel="stylesheet" href="/styles/navigation.css">
    <link rel="stylesheet" href="/styles/forecasts.css">
    <link rel="stylesheet" href="/styles/footer.css">
    <!-- FONT AWSOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="shortcut icon" href="#" type="image/x-icon">
    <title>Pronósticos</title>
</head>
<body>
    <!-- HEADER -->
    <%- include('./partials/navigation.ejs') %>
    <div class="container">
        <h1>Pronósticos</h1>
        <form id="form" action="/enviar-datos" method="POST">
            <select id="roundSelect" name="round" onchange="filterMatches()">
                <% for(let i = 1; i <= matches.length/14; i++) { %>
                <option value="<%= `1st Phase - ${i}` %>">Fecha <%= i %></option>
                <% } %>
            </select>    
            <div class="fixture">
                <table>
                    <thead>
                        <tr>
                            <th class="date">Fecha</th>
                            <th class="teams">Local</th>
                            <th>PL</th>
                            <th class="vs">-</th>
                            <th>PV</th>
                            <th class="teams">Visitante</th>
                            <th>Res.</th>
                            <th>Pts.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let i = 0; i < matches.length; i++) { %>
                            <% if (matches[i].league.round.includes('1st Phase')) { %>
                                <tr class="match-result" data-round="<%= matches[i].league.round %>">
                                    <td class="date">
                                      <% const matchDate = new Date(matches[i].fixture.date); %>
                                      <% const md = matchDate.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) %>
                                      <%= md.replace(",", "")  %>
                                    </td>
                                    <td class="teams"><div class="teams__logo"><img style="width: 25px;" src="<%= matches[i].teams.home.logo %>" alt=""><span><%= matches[i].teams.home.name %></span></div></td>
                                    <td><div class="input__cont"><input type="text" maxlength="2" oninput="validarNumeros(event)" id="localF-<%= i+1 %>" class="forecasts" name="forecastLocal-<%= i+1 %>"></div></td>
                                    <td class="vs">-</td>
                                    <td><div class="input__cont"><input type="text" maxlength="2" oninput="validarNumeros(event)" id="awayF-<%= i+1 %>" class="forecasts" name="forecastAway-<%= i+1 %>"></div></td>
                                    <td class="teams"><div class="teams__logo"><span><%= matches[i].teams.away.name %></span><img style="width: 25px;" src="<%= matches[i].teams.away.logo %>" alt=""></div></td>
                                    <td><span id="localR-<%= i+1 %>"><%= matches[i].goals.home %></span> - <span id="awayR-<%= i+1 %>"><%= matches[i].goals.away %></span></td>
                                    <td></td>
                                </tr>
                            <% } %>
                        <% } %>
                    </tbody>
                </table>
            </div>  
            <button id="send">Enviar</button>
        </form>
    </div>
    <!-- FOOTER -->
    <%- include('./partials/footer.ejs') %>


    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            const roundSelect = document.getElementById('roundSelect');
            let selectedRound = roundSelect.value;
            filterMatches(selectedRound);
    
            roundSelect.addEventListener('change', function() {
                selectedRound = roundSelect.value;
                filterMatches(selectedRound);
            });

        });
        
        // envia toda la fase
        // function filterMatches(selectedRound) {
        //     const matchResults = document.querySelectorAll('.match-result');
    
        //     for (let i = 0; i < matchResults.length; i++) {
        //         const matchRound = matchResults[i].getAttribute('data-round');
        //         if (matchRound === selectedRound) {
        //             matchResults[i].classList.add('selected-round');
        //             matchResults[i].style.display = 'block';
        //         } else {
        //             matchResults[i].classList.remove('selected-round');
        //             matchResults[i].style.display = 'none';
        //         }
        //     }
        // }

        // agraga clase select-round a todos los inputs segun el round
        function filterMatches(selectedRound) {
            const matchResults = document.querySelectorAll('.match-result');

            for (let i = 0; i < matchResults.length; i++) {
                const matchRound = matchResults[i].getAttribute('data-round');
                const inputs = matchResults[i].querySelectorAll('.forecasts');

                if (matchRound === selectedRound) {
                    // matchResults[i].classList.add('selected-round');
                    matchResults[i].style.display = 'block';

                    for (let j = 0; j < inputs.length; j++) {
                    inputs[j].classList.add('selected-round');
                    }
                } else {
                    // matchResults[i].classList.remove('selected-round');
                    matchResults[i].style.display = 'none';

                    for (let j = 0; j < inputs.length; j++) {
                    inputs[j].classList.remove('selected-round');
                    }
                }
            }
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return day + '/' + month + ' ' + hours + ':' + minutes;
        }

        function validarNumeros(event) {
            const input = event.target.value;
            event.target.value = input.replace(/[^0-9]/g, '');
        }


      
        //     // const data = {
        //     //     round: roundValue,
        //     //     forecasts: []
        //     // };
        //     const formData = new FormData();
        //     formData.append('round', roundValue);

        //     selectedInputs.forEach(input => {
        //         const IDnameForecast = input.name;
        //         const userValue = input.value;
        //         // data.forecasts.push({ IDnameForecast, userValue });
        //         formData.append(input.name, input.value);
        //     });



        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();

            const roundSelect = document.getElementById('roundSelect');
            const roundValue = roundSelect.value;

            const formData = {};
            formData['round'] = roundValue;
            document.querySelectorAll('.selected-round').forEach(function(input) {
                const name = input.name;
                const value = input.value;
                formData[name] = value;
                
            });

            // Renvio datos al servidor
            fetch('/enviar-datos', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(function(response) {
                if (response.ok) {
                    return response.ok;
                    console.log('Datos recibidos correctamente');
                } else {
                    throw new Error('Error en la solicitud');
                }
            })
            .then(function(data) {
                // Respuesta del servidor
                console.log(data);
                // Realiza redireccionamiento en el lado del servidor
                // window.location.href = '/';
            })
            .catch(function(error) {

                console.error(error);
            });
        });


    </script>

</body>
</html>
